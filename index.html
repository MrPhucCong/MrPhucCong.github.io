<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chuyển Đổi Ảnh Sang PDF</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .file-input-label {
            cursor: pointer;
            transition: all 0.2s ease-in-out;
        }
        .file-input-label:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        #generate-btn {
            transition: all 0.2s ease-in-out;
        }
        #generate-btn:disabled {
            cursor: not-allowed;
            opacity: 0.6;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center p-4">
    <div class="w-full max-w-2xl mx-auto bg-white rounded-2xl shadow-xl p-8 md:p-12 text-center">
        <!-- Header -->
        <div class="mb-8">
            <h1 class="text-3xl md:text-4xl font-bold text-gray-800">Trình Chuyển Đổi Ảnh Sang PDF</h1>
            <p class="text-gray-500 mt-2">Tải lên các tệp ảnh của bạn để gộp thành một tệp PDF duy nhất.</p>
        </div>

        <!-- File Upload Area -->
        <div class="mb-6">
            <input type="file" id="image-input" multiple accept="image/*" class="hidden">
            <label for="image-input" class="file-input-label flex flex-col items-center justify-center w-full h-48 bg-gray-50 border-2 border-dashed border-gray-300 rounded-xl hover:bg-gray-100">
                <svg class="w-12 h-12 text-gray-400 mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path></svg>
                <p class="text-gray-600 font-medium">Nhấn để chọn ảnh</p>
                <p class="text-xs text-gray-500 mt-1">Hỗ trợ các định dạng PNG, JPG, WEBP, v.v.</p>
            </label>
        </div>

        <!-- Selected Files Preview -->
        <div id="preview-container" class="mb-6 text-left">
            <p id="file-info" class="text-gray-600 font-medium">Chưa có tệp nào được chọn.</p>
            <div id="image-previews" class="grid grid-cols-3 sm:grid-cols-4 md:grid-cols-6 gap-3 mt-4"></div>
        </div>
        
        <!-- Action Button -->
        <button id="generate-btn" class="w-full bg-blue-600 text-white font-bold py-3 px-6 rounded-lg shadow-md hover:bg-blue-700 focus:outline-none focus:ring-4 focus:ring-blue-300 disabled:bg-blue-400">
            Tạo File PDF
        </button>

        <!-- Status Message -->
        <div id="status" class="mt-4 text-sm text-gray-600 h-5"></div>
    </div>

    <script>
        const imageInput = document.getElementById('image-input');
        const generateBtn = document.getElementById('generate-btn');
        const statusDiv = document.getElementById('status');
        const fileInfo = document.getElementById('file-info');
        const imagePreviews = document.getElementById('image-previews');

        let selectedFiles = [];

        // Update UI when files are selected
        imageInput.addEventListener('change', () => {
            selectedFiles = Array.from(imageInput.files);
            imagePreviews.innerHTML = ''; // Clear previous previews
            if (selectedFiles.length > 0) {
                fileInfo.textContent = `${selectedFiles.length} tệp đã được chọn:`;
                selectedFiles.forEach(file => {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const img = document.createElement('img');
                        img.src = e.target.result;
                        img.className = 'w-full h-20 object-cover rounded-md border';
                        img.title = file.name;
                        imagePreviews.appendChild(img);
                    };
                    reader.readAsDataURL(file);
                });
            } else {
                fileInfo.textContent = 'Chưa có tệp nào được chọn.';
            }
        });

        // Handle PDF generation on button click
        generateBtn.addEventListener('click', async () => {
            if (selectedFiles.length === 0) {
                statusDiv.textContent = 'Vui lòng chọn ít nhất một ảnh.';
                statusDiv.classList.add('text-red-500');
                return;
            }

            // Disable button and show loading status
            generateBtn.disabled = true;
            generateBtn.textContent = 'Đang xử lý...';
            statusDiv.textContent = 'Bắt đầu tạo PDF...';
            statusDiv.classList.remove('text-red-500');

            try {
                // Initialize jsPDF. 'p' for portrait, 'mm' for millimeters, 'a4' for page size.
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF('p', 'mm', 'a4');

                for (let i = 0; i < selectedFiles.length; i++) {
                    const file = selectedFiles[i];
                    statusDiv.textContent = `Đang thêm ảnh ${i + 1}/${selectedFiles.length}: ${file.name}`;
                    
                    const imgData = await readFileAsDataURL(file);
                    const imgDimensions = await getImageDimensions(imgData);

                    // A4 page dimensions in mm
                    const pdfWidth = pdf.internal.pageSize.getWidth();
                    const pdfHeight = pdf.internal.pageSize.getHeight();
                    
                    // Calculate image ratio to fit page
                    const imgRatio = imgDimensions.width / imgDimensions.height;
                    const pageRatio = pdfWidth / pdfHeight;

                    let finalWidth, finalHeight, posX, posY;

                    if (imgRatio > pageRatio) {
                        // Image is wider than page
                        finalWidth = pdfWidth;
                        finalHeight = pdfWidth / imgRatio;
                    } else {
                        // Image is taller than or equal to page aspect ratio
                        finalHeight = pdfHeight;
                        finalWidth = pdfHeight * imgRatio;
                    }

                    // Center the image on the page
                    posX = (pdfWidth - finalWidth) / 2;
                    posY = (pdfHeight - finalHeight) / 2;

                    // Add the image to the PDF
                    pdf.addImage(imgData, 'JPEG', posX, posY, finalWidth, finalHeight);

                    // Add a new page for the next image, but not after the last one
                    if (i < selectedFiles.length - 1) {
                        pdf.addPage();
                    }
                }

                statusDiv.textContent = 'Tạo PDF thành công! Đang tải xuống...';
                pdf.save('mrphuccong-images.pdf');
                
                setTimeout(() => {
                    statusDiv.textContent = '';
                }, 3000);

            } catch (error) {
                console.error('Lỗi khi tạo PDF:', error);
                statusDiv.textContent = 'Đã xảy ra lỗi. Vui lòng thử lại.';
                statusDiv.classList.add('text-red-500');
            } finally {
                // Re-enable button
                generateBtn.disabled = false;
                generateBtn.textContent = 'Tạo File PDF';
            }
        });

        // Helper function to read a file as a Data URL
        function readFileAsDataURL(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

        // Helper function to get image dimensions
        function getImageDimensions(dataUrl) {
            return new Promise((resolve, reject) => {
                const img = new Image();
                img.onload = () => resolve({ width: img.width, height: img.height });
                img.onerror = reject;
                img.src = dataUrl;
            });
        }
    </script>
</body>
</html>
